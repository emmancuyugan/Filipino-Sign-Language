{% extends "base.html" %}
{% block title %}Auto Recognition ‚Äì FSL Learning{% endblock %}
<!-- Cache bust: {{ range(1, 2)|random }} -->
{% block content %}

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  :root {
    --sunshine: #FFD93D;
    --sky-blue: #4CC9F0;
    --grass-green: #06D6A0;
    --coral: #FF6B9D;
    --lavender: #A78BFA;
    --orange: #FF8C42;
    --deep-blue: #4361EE;
    --white: #FFFFFF;
    --off-white: #FFF8F0;
    --shadow: rgba(0, 0, 0, 0.15);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    font-weight: 600;
    background: linear-gradient(135deg, #E0F4FF 0%, #FFE5EC 50%, #FFF4E0 100%);
    background-attachment: fixed;
    min-height: 100vh;
    position: relative;
  }

  /* Animated floating shapes background */
  .bg-shapes {
    position: fixed;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
    z-index: 0;
  }

  .shape {
    position: absolute;
    opacity: 0.15;
    animation: float 20s infinite ease-in-out;
  }

  .shape:nth-child(1) { 
    width: 120px; 
    height: 120px; 
    background: var(--sunshine); 
    border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
    top: 10%; 
    left: 5%; 
    animation-delay: 0s;
  }

  .shape:nth-child(2) { 
    width: 90px; 
    height: 90px; 
    background: var(--coral); 
    border-radius: 50%;
    top: 60%; 
    left: 80%; 
    animation-delay: 3s;
  }

  .shape:nth-child(3) { 
    width: 150px; 
    height: 150px; 
    background: var(--grass-green); 
    border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
    bottom: 10%; 
    right: 10%; 
    animation-delay: 6s;
  }

  .shape:nth-child(4) { 
    width: 100px; 
    height: 100px; 
    background: var(--lavender); 
    border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
    top: 30%; 
    right: 20%; 
    animation-delay: 9s;
  }

  @keyframes float {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    25% { transform: translate(20px, -20px) rotate(5deg); }
    50% { transform: translate(-15px, 15px) rotate(-5deg); }
    75% { transform: translate(10px, -10px) rotate(3deg); }
  }

  .app-container {
    position: relative;
    z-index: 1;
    width: 100%;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 20px;
    gap: 20px;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--white);
    padding: 15px 25px;
    border-radius: 30px;
    box-shadow: 0 8px 24px var(--shadow);
    animation: slideDown 0.6s ease-out;
  }

  @keyframes slideDown {
    from { transform: translateY(-100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .logo {
    font-size: 32px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--deep-blue), var(--lavender), var(--coral));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -1px;
  }

  .status-badge {
    padding: 12px 28px;
    background: linear-gradient(135deg, var(--grass-green), var(--sky-blue));
    color: var(--white);
    border-radius: 20px;
    font-weight: 700;
    font-size: 20px;
    box-shadow: 0 4px 12px rgba(6, 214, 160, 0.3);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  .main-content {
    display: flex;
    gap: 20px;
    flex: 1;
    min-height: 0;
  }

  .camera-section {
    flex: 2;
    position: relative;
    background: var(--white);
    border-radius: 30px;
    box-shadow: 0 8px 32px var(--shadow);
    overflow: hidden;
    animation: scaleIn 0.6s ease-out 0.2s backwards;
  }

  @keyframes scaleIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .camera-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    background: #000;
    border-radius: 30px;
    overflow: hidden;
  }

  #cam {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 30px;
  }

  #overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .live-badge {
    padding: 12px 24px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 20px;
    display: none;
    box-shadow: 0 4px 16px rgba(255, 107, 157, 0.5);
    animation: blink 1.5s infinite;
    background: var(--coral);
    color: var(--white);
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  .live-dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    background: var(--white);
    border-radius: 50%;
    margin-right: 8px;
    animation: pulse-dot 1.5s infinite;
  }

  @keyframes pulse-dot {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.3); }
  }

  .result-overlay {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.85);
    color: var(--white);
    padding: 16px 32px;
    border-radius: 24px;
    font-size: 28px;
    font-weight: 700;
    display: none;
    z-index: 10;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  @keyframes popIn {
    from { transform: translateX(-50%) scale(0); }
    to { transform: translateX(-50%) scale(1); }
  }

  .timer-overlay {
    position: absolute;
    top: 20px;
    right: 20px;
    background: var(--sunshine);
    color: #333;
    padding: 20px 28px;
    border-radius: 20px;
    font-size: 40px;
    font-weight: 700;
    display: none;
    z-index: 10;
    box-shadow: 0 8px 24px rgba(255, 217, 61, 0.5);
    min-width: 80px;
    text-align: center;
  }

  .ghost-badge {
    position: absolute;
    top: 100px;
    right: 20px;
    background: var(--lavender);
    color: var(--white);
    padding: 12px 20px;
    border-radius: 20px;
    font-size: 18px;
    font-weight: 700;
    display: none;
    z-index: 10;
    box-shadow: 0 4px 16px rgba(167, 139, 250, 0.5);
  }

  .settings-panel {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 20px;
    box-shadow: 0 4px 16px var(--shadow);
    z-index: 9;
    backdrop-filter: blur(10px);
  }

  .setting-item {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    font-size: 16px;
    font-weight: 600;
    color: #333;
    cursor: pointer;
    user-select: none;
  }

  .setting-item:last-child {
    margin-bottom: 0;
  }

  .setting-item input[type="checkbox"] {
    width: 24px;
    height: 24px;
    margin-right: 10px;
    cursor: pointer;
    accent-color: var(--grass-green);
  }

  .control-buttons {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 16px;
    z-index: 10;
  }

  .big-button {
    padding: 20px 48px;
    font-size: 24px;
    font-weight: 700;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    box-shadow: 0 6px 20px var(--shadow);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .big-button:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 10px 30px var(--shadow);
  }

  .big-button:active {
    transform: translateY(-2px) scale(1.02);
  }

  .start-btn {
    background: linear-gradient(135deg, var(--grass-green), var(--sky-blue));
    color: var(--white);
  }

  .stop-btn {
    background: linear-gradient(135deg, var(--coral), var(--orange));
    color: var(--white);
    display: none;
  }

  .sidebar {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 20px;
    animation: slideLeft 0.6s ease-out 0.4s backwards;
  }

  @keyframes slideLeft {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  .card {
    background: var(--white);
    border-radius: 25px;
    padding: 25px;
    box-shadow: 0 8px 24px var(--shadow);
    display: flex;
    flex-direction: column;
  }

  .card-title {
    font-size: 18px;
    font-weight: 700;
    color: #666;
    margin-bottom: 12px;
  }

  .detection-card {
    flex: 0 0 auto;
  }

  .detected-sign {
    font-size: 48px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--deep-blue), var(--lavender));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 8px;
    min-height: 60px;
    display: flex;
    align-items: center;
  }

  .detection-status {
    font-size: 24px;
    font-weight: 700;
    color: #888;
  }

  .frame-count {
    font-size: 16px;
    color: #999;
    margin-top: 8px;
    display: none;
  }

  .history-card {
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
  }

  .history-content {
    flex: 1;
    background: var(--off-white);
    border-radius: 15px;
    padding: 15px;
    overflow-y: auto;
    font-size: 14px;
    margin-bottom: 16px;
    border: 3px dashed #DDD;
  }

  .history-content::-webkit-scrollbar {
    width: 8px;
  }

  .history-content::-webkit-scrollbar-track {
    background: transparent;
  }

  .history-content::-webkit-scrollbar-thumb {
    background: var(--sky-blue);
    border-radius: 10px;
  }

  .clear-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--orange), var(--sunshine));
    color: var(--white);
    border: none;
    border-radius: 15px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(255, 140, 66, 0.3);
  }

  .clear-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 24px rgba(255, 140, 66, 0.4);
  }

  .clear-btn:active {
    transform: translateY(-1px);
  }

  .confetti {
    position: fixed;
    width: 10px;
    height: 10px;
    background: var(--sunshine);
    position: absolute;
    animation: confetti-fall 3s linear forwards;
    z-index: 1000;
    pointer-events: none;
  }

  @keyframes confetti-fall {
    to {
      transform: translateY(100vh) rotate(360deg);
      opacity: 0;
    }
  }

  @media (max-width: 1024px) {
    .app-container {
      padding: 15px;
      gap: 15px;
    }

    .logo {
      font-size: 24px;
    }

    .status-badge {
      font-size: 16px;
      padding: 10px 20px;
    }

    .big-button {
      padding: 16px 36px;
      font-size: 20px;
    }

    .detected-sign {
      font-size: 36px;
    }
  }

    /* =========================================================
    FIX: Prevent sidebar/history from stretching the whole UI
    Make only the history list scroll
    ========================================================= */

  /* Lock app to viewport height (so the page doesn't grow) */
  .app-container {
    height: 100vh;     /* was min-height: 100vh */
    min-height: 0;     /* critical for flex scrolling */
  }

  /* Ensure the flex row can shrink and children can scroll */
  .main-content {
    min-height: 0;
  }

  /* Prevent sidebar content from pushing layout taller */
  .sidebar {
    min-height: 0;
    overflow: hidden;  /* contain scrolling inside history-content */
  }

  /* Make camera section fill available height and not be stretched by sidebar */
  .camera-section {
    min-height: 0;
    display: flex;
  }

  .camera-wrapper {
    flex: 1;
    height: 100%;
    min-height: 0;
  }

  /* History card: allow internal scroll */
  .history-card {
    min-height: 0;
  }

  /* This is the only thing that should scroll */
  .history-content {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
  }

  /* Touchscreen-friendly: disable hover lift effects on touch devices */
  @media (hover: none), (pointer: coarse) {
    .big-button:hover,
    .clear-btn:hover {
      transform: none !important;
      box-shadow: 0 6px 20px var(--shadow) !important;
    }
  }

</style>

<div class="bg-shapes">
  <div class="shape"></div>
  <div class="shape"></div>
  <div class="shape"></div>
  <div class="shape"></div>
</div>

<div class="app-container">
  <div class="header">
    <div class="logo">[FSL] FSL Learning</div>
    <div style="display: flex; align-items: center; gap: 16px;">
      <div class="live-badge" id="recBadge">
        <span class="live-dot"></span>LIVE
      </div>
      <div class="status-badge" id="stateBadge">Ready to Learn!</div>
    </div>
  </div>

  <div class="main-content">
    <div class="camera-section">
      <div class="camera-wrapper">
        <video id="cam" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>

        <div class="result-overlay" id="gestureOverlay">‚Äî</div>

        <div class="timer-overlay" id="timerOverlay">5</div>

        <div class="ghost-badge" id="ghostBadge">[Guide] Ghost Helper ON</div>

        <div class="settings-panel">
          <div class="setting-item">
            <input type="checkbox" id="toggleVisuals" checked>
            <span>[Eye] Hand Markers</span>
          </div>
          <div class="setting-item">
            <input type="checkbox" id="toggleTimer" checked>
            <span>[Timer] Timer</span>
          </div>
          <div class="setting-item">
            <input type="checkbox" id="toggleResults" checked>
            <span>[Note] Show Results</span>
          </div>
          <div class="setting-item">
            <input type="checkbox" id="toggleSpeed">
            <span>‚ö° Fast Mode</span>
          </div>
        </div>

        <div class="control-buttons">
          <button class="big-button start-btn" id="startBtn">‚ñ∂Ô∏è Start Learning!</button>
          <button class="big-button stop-btn" id="stopBtn">‚ñ† Stop</button>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="card detection-card">
        <div class="card-title">What You're Signing:</div>
        <div class="detected-sign" id="detLabel">‚Äî</div>
        <div class="detection-status" id="detStatus">Ready to start!</div>
        <div class="frame-count" id="frameInfo">Capturing...</div>
      </div>

      <div class="card history-card">
        <div class="card-title">Your Practice History [Book]</div>
        <div class="history-content" id="history">
          <div style="color: #999;">Start signing to see your progress!</div>
        </div>
        <button class="clear-btn" id="clearBtn">üóëÔ∏è Clear History</button>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='mediapipe/camera_utils/camera_utils.js') }}"></script>
<script src="{{ url_for('static', filename='mediapipe/drawing_utils/drawing_utils.js') }}"></script>
<script src="{{ url_for('static', filename='mediapipe/holistic/holistic.js') }}"></script>

<script>
(() => {
  const ENABLE_CONFETTI = false; // keep look, disable expensive confetti

  const videoEl=document.getElementById('cam');
  const canvasEl=document.getElementById('overlay');
  const ctx=canvasEl.getContext('2d');
  const startBtn=document.getElementById('startBtn');
  const stopBtn=document.getElementById('stopBtn');
  const clearBtn=document.getElementById('clearBtn');
  const detLabel=document.getElementById('detLabel');
  const detStatus=document.getElementById('detStatus');
  const recBadge=document.getElementById('recBadge');
  const historyEl=document.getElementById('history');
  const stateBadge=document.getElementById('stateBadge');
  const frameInfo=document.getElementById('frameInfo');
  const toggleVisuals=document.getElementById('toggleVisuals');
  const toggleTimer=document.getElementById('toggleTimer');
  const toggleResults=document.getElementById('toggleResults');
  const toggleSpeed=document.getElementById('toggleSpeed');
  const gestureOverlay=document.getElementById('gestureOverlay');
  const timerOverlay=document.getElementById('timerOverlay');
  const ghostBadge=document.getElementById('ghostBadge');

  const PREDICT_URL=location.origin+'/predict_auto';
  const SEQ_LEN=48;
  let buf=[],running=false,handsPresent=false,frameCount=0,showVisuals=true,showTimer=true,showResults=true;
  let predictInterval=null,tickInterval=null,countdown=5;

  const HAND_CONN=[[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[0,9],[9,10],[10,11],[11,12],[0,13],[13,14],[14,15],[15,16],[0,17],[17,18],[18,19],[19,20]];

  let ghostEnabled=false;
  let ghostFrames=null;
  let ghostIdx=0;
  let ghostReady=false;
  let loadingGhost=false;
  let scaleMultiplier=1.08;
  let yOffset=-0.08;
  let ghostPlaybackSpeed=0.25;
  let ghostTimer=null;
  const GHOST_DURATION_MS=12000;

  function flattenHand(lms){if(!lms)return new Float32Array(63);const a=[];for(let i=0;i<21;i++){const p=lms[i];a.push(p.x,p.y,p.z);}return new Float32Array(a);}
  function lm(list,idx){if(!list||idx>=list.length)return{x:NaN,y:NaN,z:NaN};return list[idx];}
  function dist2D(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.hypot(dx,dy)||1e-6;}
  function normalizeGlobal(hand63,a){
    if(!hand63||hand63.length!==63||!a.L_SH||!a.R_SH)return new Float32Array(63);
    const out=new Float32Array(63);
    const Cx=(a.L_SH.x+a.R_SH.x)/2,Cy=(a.L_SH.y+a.R_SH.y)/2,Cz=(a.L_SH.z+a.R_SH.z)/2;
    const scale=Math.max(1e-6,dist2D(a.L_SH,a.R_SH));
    for(let i=0;i<63;i+=3){out[i]=(hand63[i]-Cx)/scale;out[i+1]=(hand63[i+1]-Cy)/scale;out[i+2]=(hand63[i+2]-Cz)/scale;}
    return out;
  }
  function derivedAltitudeFeatures(L,R,a){
    const out=[],SEL=[0,4,8,12,16,20],brow_y=0.5*(a.brow_r.y+a.brow_l.y);
    for(const H of [L,R]){
      for(const j of SEL){
        const by=j*3+1,bz=j*3+2;
        const py=H[by],pz=H[bz];
        out.push(py-a.chin.y,py-a.lip_u.y,py-brow_y,py-a.forehead.y,pz-a.nose.z);
      }
    }
    return new Float32Array(out);
  }
  function packFeature(res){
    const p=res.poseLandmarks||[],f=res.faceLandmarks||[];
    const a={L_SH:lm(p,11),R_SH:lm(p,12),nose:lm(f,1),forehead:lm(f,10),lip_u:lm(f,13),brow_r:lm(f,65),brow_l:lm(f,295),chin:lm(f,152)};
    const Lh=res.rightHandLandmarks?flattenHand(res.rightHandLandmarks):null;
    const Rh=res.leftHandLandmarks?flattenHand(res.leftHandLandmarks):null;
    if(!Lh&&!Rh)return null;
    const L=normalizeGlobal(Lh,a),R=normalizeGlobal(Rh,a);
    const alt=derivedAltitudeFeatures(L,R,a);
    return new Float32Array([...L,...R,...alt,Lh?1:0,Rh?1:0]);
  }
  function temporalFix(frames,n){
    if(frames.length<=n){
      const pad=Array.from({length:n-frames.length},()=>frames[frames.length-1]);
      return frames.concat(pad);
    }
    const step=frames.length/n;const out=[];
    for(let i=0;i<n;i++){const idx=Math.min(Math.floor(i*step),frames.length-1);out.push(frames[idx]);}
    return out;
  }

  function anchorsValid(a){
    return a&&a.L_SH&&a.R_SH&&Number.isFinite(a.L_SH.x)&&Number.isFinite(a.R_SH.x)&&Number.isFinite(a.L_SH.y)&&Number.isFinite(a.R_SH.y);
  }

  function drawGhostHand(norm63,anchors,ctx,color){
    if(!norm63)return;
    const baseScale=Math.max(1e-6,dist2D(anchors.L_SH,anchors.R_SH));
    const scale=baseScale*scaleMultiplier;
    const Cx=(anchors.L_SH.x+anchors.R_SH.x)/2;
    const Cy=(anchors.L_SH.y+anchors.R_SH.y)/2+yOffset;

    const pts=[];
    for(let i=0;i<63;i+=3){
      pts.push({x:norm63[i]*scale+Cx,y:norm63[i+1]*scale+Cy});
    }

    ctx.save();
    ctx.globalCompositeOperation='screen';
    ctx.strokeStyle=color;
    ctx.fillStyle=color;
    ctx.lineWidth=6;

    const W=canvasEl.width,H=canvasEl.height;
    for(const[a,b]of HAND_CONN){
      const p=pts[a],q=pts[b];
      ctx.beginPath();
      ctx.moveTo(p.x*W,p.y*H);
      ctx.lineTo(q.x*W,q.y*H);
      ctx.stroke();
    }
    for(const p of pts){
      ctx.beginPath();
      ctx.arc(p.x*W,p.y*H,8,0,2*Math.PI);
      ctx.fill();
    }
    ctx.restore();
  }

  function normLabel(s){
    if(!s)return "";
    let x=String(s).toLowerCase();
    x=x.replace(/^(numbers_|colors_|color_|family_|relationship_|survival_)/,"");
    x=x.replace(/[^a-z0-9]+/g,'');
    const map={"1":"one","2":"two","3":"three","4":"four","5":"five","grandmother":"grandmother","grandma":"grandmother","lola":"grandmother","grandfather":"grandfather","grandpa":"grandfather","lolo":"grandfather","mom":"mother","mother":"mother","nanay":"mother","dad":"father","father":"father","tatay":"father","boy":"boy","girl":"girl","man":"man","woman":"woman","son":"son","daughter":"daughter","black":"black","blue":"blue","green":"green","orange":"orange","pink":"pink","red":"red","white":"white","yellow":"yellow","correct":"correct","dontunderstand":"dontunderstand","no":"no","understand":"understand","wrong":"wrong","yes":"yes"};
    return map[x]||x;
  }

  function inferCategory(label){
    const raw=String(label).toLowerCase();
    if(raw.startsWith("numbers_"))return "numbers";
    if(raw.startsWith("colors_")||raw.startsWith("color_"))return "colors";
    if(raw.startsWith("family_"))return "family";
    if(raw.startsWith("relationship_"))return "relationship";
    if(raw.startsWith("survival_"))return "survival";
    const l=normLabel(label);
    const numbers=["one","two","three","four","five"];
    const family=["daughter","father","grandfather","grandmother","mother","son"];
    const relationship=["boy","girl","man","woman"];
    const survival=["correct","dontunderstand","no","understand","wrong","yes"];
    if(numbers.includes(l))return "numbers";
    if(family.includes(l))return "family";
    if(relationship.includes(l))return "relationship";
    if(survival.includes(l))return "survival";
    return "colors";
  }

  async function findDemoUrl(cat,key){
    const STATIC_BASE=(window.location.origin+'/static/video').replace(/\/+$/,'');
    const candidates=[];
    for(let i=1;i<=10;i++){
      candidates.push(`${key}_${String(i).padStart(2,'0')}.mp4`);
    }
    candidates.push(`${key}.mp4`);
    for(const n of candidates){
      const url=`${STATIC_BASE}/${cat}/${n}`;
      try{
        const r=await fetch(url,{method:'HEAD',cache:'no-store'});
        if(r.ok)return url;
      }catch(_){}
    }
    return null;
  }

  async function loadGhostFor(label){
    const cat=inferCategory(label);
    const key=normLabel(label);
    const url=await findDemoUrl(cat,key);
    if(!url)return false;

    const v=document.createElement('video');
    v.src=url;
    v.muted=true;
    v.playsInline=true;
    v.crossOrigin='anonymous';

    await new Promise((resolve,reject)=>{
      v.onloadedmetadata=resolve;
      v.onerror=()=>reject(new Error('Video error'));
    });

    ghostFrames=[];
    const ghostHolistic=new Holistic({locateFile: (f) => `/static/mediapipe/holistic/${f}`});
    ghostHolistic.setOptions({selfieMode:false,modelComplexity:1,smoothLandmarks:true,refineFaceLandmarks:false,minDetectionConfidence:0.5,minTrackingConfidence:0.5});

    ghostHolistic.onResults(res=>{
      const pose=res.poseLandmarks||[];
      const face=res.faceLandmarks||[];
      const anchors={L_SH:lm(pose,11),R_SH:lm(pose,12),nose:lm(face,1),forehead:lm(face,10),lip_u:lm(face,13),brow_r:lm(face,65),brow_l:lm(face,295),chin:lm(face,152)};
      const Lh=res.rightHandLandmarks?flattenHand(res.rightHandLandmarks):null;
      const Rh=res.leftHandLandmarks?flattenHand(res.leftHandLandmarks):null;
      if(!Lh&&!Rh)return;
      const L=Lh?normalizeGlobal(Lh,anchors):null;
      const R=Rh?normalizeGlobal(Rh,anchors):null;
      ghostFrames.push({L,R});
    });

    const total=24;
    for(let i=0;i<total;i++){
      v.currentTime=(v.duration*i)/total;
      await new Promise(r=>v.onseeked=r);
      await ghostHolistic.send({image:v});
    }

    ghostReady=ghostFrames&&ghostFrames.length>0;
    return ghostReady;
  }

  function celebrate(){
    if(!ENABLE_CONFETTI) return;
    for(let i=0;i<30;i++){
      setTimeout(()=>{
        const confetti=document.createElement('div');
        confetti.className='confetti';
        confetti.style.left=Math.random()*100+'%';
        confetti.style.background=['#FFD93D','#FF6B9D','#06D6A0','#4CC9F0','#A78BFA'][Math.floor(Math.random()*5)];
        confetti.style.animationDelay=Math.random()*0.5+'s';
        document.body.appendChild(confetti);
        setTimeout(()=>confetti.remove(),3000);
      },i*50);
    }
  }

  const holistic=new Holistic({locateFile: (f) => `/static/mediapipe/holistic/${f}`});
  holistic.setOptions({selfieMode:false,modelComplexity:2,smoothLandmarks:true,refineFaceLandmarks:false,minDetectionConfidence:0.55,minTrackingConfidence:0.55});

  holistic.onResults(res=>{
    ctx.clearRect(0,0,canvasEl.width,canvasEl.height);
    ctx.drawImage(res.image,0,0,canvasEl.width,canvasEl.height);
    const RH=res.rightHandLandmarks,LH=res.leftHandLandmarks;
    handsPresent=!!(RH||LH);
    if(showVisuals&&handsPresent){
      const drawBox=(h,color)=>{
        let minX=1,minY=1,maxX=0,maxY=0;
        h.forEach(p=>{minX=Math.min(minX,p.x);maxX=Math.max(maxX,p.x);minY=Math.min(minY,p.y);maxY=Math.max(maxY,p.y);});
        ctx.strokeStyle=color;ctx.lineWidth=4;
        ctx.strokeRect(minX*canvasEl.width,minY*canvasEl.height,(maxX-minX)*canvasEl.width,(maxY-minY)*canvasEl.height);
        h.forEach(p=>{ctx.beginPath();ctx.arc(p.x*canvasEl.width,p.y*canvasEl.height,6,0,2*Math.PI);ctx.fillStyle=color;ctx.fill();});
      };
      if(RH)drawBox(RH,'rgba(6,214,160,0.9)');
      if(LH)drawBox(LH,'rgba(255,107,157,0.9)');
    }

    const pose=res.poseLandmarks||[];
    const anchors={L_SH:lm(pose,11),R_SH:lm(pose,12)};

    if(ghostEnabled&&ghostReady&&anchorsValid(anchors)&&ghostFrames&&ghostFrames.length){
      ghostIdx+=ghostPlaybackSpeed;
      if(ghostIdx>=ghostFrames.length)ghostIdx=0;

      const frameA=ghostFrames[Math.floor(ghostIdx)%ghostFrames.length];
      const frameB=ghostFrames[Math.floor(ghostIdx+1)%ghostFrames.length];
      const t=ghostIdx%1;

      const L=frameA.L&&frameB.L?new Float32Array(63):null;
      const R=frameA.R&&frameB.R?new Float32Array(63):null;

      if(L){
        for(let i=0;i<63;i++)L[i]=(1-t)*frameA.L[i]+t*frameB.L[i];
      }
      if(R){
        for(let i=0;i<63;i++)R[i]=(1-t)*frameA.R[i]+t*frameB.R[i];
      }

      if(L)drawGhostHand(L,anchors,ctx,'rgba(167,139,250,0.85)');
      if(R)drawGhostHand(R,anchors,ctx,'rgba(76,201,240,0.85)');
      ghostBadge.style.display='inline-block';
    }else{
      ghostBadge.style.display='none';
    }

    const feat=packFeature(res);
    if(running&&feat){
      buf.push(feat);
      if(buf.length>SEQ_LEN)buf.shift();
      frameCount=buf.length;
      frameInfo.textContent='Capturing: '+frameCount+' frames';
      frameInfo.style.display='block';
    }
  });

  const camera=new Camera(videoEl,{onFrame:async()=>{await holistic.send({image:videoEl});},width:640,height:480});

  async function predict(){
    if(buf.length<5)return;
    const fixed=temporalFix(buf,SEQ_LEN);
    const seq=fixed.flatMap(f=>Array.from(f));
    try{
      const res=await fetch(PREDICT_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sequence:seq})});
      const j=await res.json();
      if(!showResults)return;

      // Update history
      const now=new Date().toLocaleTimeString();
      const histEntry=document.createElement('div');
      histEntry.style.marginBottom='8px';
      histEntry.style.padding='8px';
      histEntry.style.borderRadius='8px';
      histEntry.style.background='rgba(255,255,255,0.6)';

      if(j.prediction==='Incorrect'){
        histEntry.innerHTML=`<strong style="color:var(--coral);">${now}</strong>: ‚úó Incorrect (closest: ${j.closest_sign||'‚Äî'})`;
        gestureOverlay.textContent=`‚úó Try Again! Hint: ${j.closest_sign||'‚Äî'}`;
        gestureOverlay.style.display='block';
        gestureOverlay.style.background='rgba(255,107,157,0.9)';
        detLabel.textContent=j.closest_sign||'‚Äî';
        detStatus.textContent='Try again!';

        if(j.closest_sign&&!loadingGhost){
          loadingGhost=true;
          ghostEnabled=false;
          ghostReady=false;
          ghostFrames=null;
          ghostIdx=0;
          if(ghostTimer)clearTimeout(ghostTimer);

          try{
            const ok=await loadGhostFor(j.closest_sign);
            if(ok){
              ghostEnabled=true;
              ghostTimer=setTimeout(()=>{
                ghostEnabled=false;
                ghostReady=false;
                ghostFrames=null;
                ghostBadge.style.display='none';
              },GHOST_DURATION_MS);
            }
          }catch(e){
            console.error('Ghost load error',e);
          }finally{
            loadingGhost=false;
          }
        }
      }else{
        histEntry.innerHTML=`<strong style="color:var(--grass-green);">${now}</strong>: ‚úì ${j.prediction||'‚Äî'}`;
        gestureOverlay.textContent=`‚úì Great Job! ${j.prediction||'‚Äî'}`;
        gestureOverlay.style.display='block';
        gestureOverlay.style.background='rgba(6,214,160,0.9)';
        detLabel.textContent=j.prediction||'‚Äî';
        detStatus.textContent='Correct! Keep going!';
        celebrate();

        ghostEnabled=false;
        ghostReady=false;
        ghostFrames=null;
        if(ghostTimer)clearTimeout(ghostTimer);
        ghostBadge.style.display='none';
      }

      // Add to history (prepend so newest is on top)
      if(historyEl.children.length===1&&historyEl.children[0].style.color==='#999'){
        historyEl.innerHTML='';
      }
      historyEl.insertBefore(histEntry,historyEl.firstChild);
      historyEl.scrollTop = 0;

    }catch(e){
      console.error(e);
      gestureOverlay.textContent='‚ö†Ô∏è Oops! Try again';
      gestureOverlay.style.display='block';
      gestureOverlay.style.background='rgba(255,140,66,0.9)';
      detStatus.textContent='Connection error';
    }
  }

  toggleVisuals.onchange=()=>{showVisuals=toggleVisuals.checked;};
  toggleTimer.onchange=()=>{showTimer=toggleTimer.checked;timerOverlay.style.display=showTimer?'block':'none';};
  toggleResults.onchange=()=>{showResults=toggleResults.checked;gestureOverlay.style.display=showResults?'block':'none';};

  startBtn.onclick=async()=>{
    document.body.classList.add('camera-running');
    if(running)return;
    running=true;
    buf=[];
    frameCount=0;
    recBadge.style.display='inline-block';
    stateBadge.textContent='Learning Mode ON! üéì';
    stateBadge.style.background='linear-gradient(135deg, var(--coral), var(--orange))';
    await camera.start();
    startBtn.style.display='none';
    stopBtn.style.display='inline-block';

    const fastMode=toggleSpeed.checked;
    const intervalMs=fastMode?3000:5000;
    countdown=fastMode?3:5;

    timerOverlay.textContent=countdown;
    timerOverlay.style.display=showTimer?'block':'none';

    tickInterval=setInterval(()=>{
      countdown--;
      if(countdown<=0)countdown=fastMode?3:5;
      timerOverlay.textContent=countdown;
      if(countdown<=1)timerOverlay.style.background='var(--coral)';
      else if(countdown<=2)timerOverlay.style.background='var(--orange)';
      else timerOverlay.style.background='var(--sunshine)';
    },1000);

    setTimeout(()=>{predict();},1000);
    predictInterval=setInterval(predict,intervalMs);
  };

  stopBtn.onclick=async()=>{
    document.body.classList.remove('camera-running');
    running=false;
    recBadge.style.display='none';
    stateBadge.textContent='Ready to Learn!';
    stateBadge.style.background='linear-gradient(135deg, var(--grass-green), var(--sky-blue))';
    clearInterval(predictInterval);clearInterval(tickInterval);
    timerOverlay.style.display='none';
    gestureOverlay.style.display='none';
    frameInfo.style.display='none';
    detLabel.textContent='‚Äî';
    detStatus.textContent='Ready to start!';
    ghostEnabled=false;
    ghostReady=false;
    ghostFrames=null;
    ghostBadge.style.display='none';
    if(ghostTimer)clearTimeout(ghostTimer);
    try{await camera.stop();}catch(_){}
    stopBtn.style.display='none';startBtn.style.display='inline-block';
  };

  clearBtn.onclick=()=>{historyEl.innerHTML='<div style="color: #999;">Start signing to see your progress!</div>';};

  function resize(){canvasEl.width=videoEl.clientWidth;canvasEl.height=videoEl.clientHeight;}
  new ResizeObserver(resize).observe(videoEl);resize();
})();
</script>

{% endblock %}