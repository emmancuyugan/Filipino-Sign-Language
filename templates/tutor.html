{% extends "base.html" %}
{% block title %}Learn - FSL Learning Platform{% endblock %}
{% block content %}

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  :root {
    --sunshine: #FFD93D;
    --sky-blue: #4CC9F0;
    --grass-green: #06D6A0;
    --coral: #FF6B9D;
    --lavender: #A78BFA;
    --orange: #FF8C42;
    --deep-blue: #4361EE;
    --white: #FFFFFF;
    --off-white: #FFF8F0;
    --shadow: rgba(0, 0, 0, 0.15);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    font-weight: 600;
    background: linear-gradient(135deg, #E0F4FF 0%, #FFE5EC 50%, #FFF4E0 100%);
    background-attachment: fixed;
    min-height: 100vh;
    position: relative;
  }

  .bg-shapes {
    position: fixed;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
    z-index: 0;
  }

  .shape {
    position: absolute;
    opacity: 0.15;
    animation: float 20s infinite ease-in-out;
  }

  .shape:nth-child(1) { 
    width: 120px; 
    height: 120px; 
    background: var(--sunshine); 
    border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
    top: 10%; 
    left: 5%; 
    animation-delay: 0s;
  }

  .shape:nth-child(2) { 
    width: 90px; 
    height: 90px; 
    background: var(--coral); 
    border-radius: 50%;
    top: 60%; 
    left: 80%; 
    animation-delay: 3s;
  }

  .shape:nth-child(3) { 
    width: 150px; 
    height: 150px; 
    background: var(--grass-green); 
    border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
    bottom: 10%; 
    right: 10%; 
    animation-delay: 6s;
  }

  .shape:nth-child(4) { 
    width: 100px; 
    height: 100px; 
    background: var(--lavender); 
    border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
    top: 30%; 
    right: 20%; 
    animation-delay: 9s;
  }

  @keyframes float {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    25% { transform: translate(20px, -20px) rotate(5deg); }
    50% { transform: translate(-15px, 15px) rotate(-5deg); }
    75% { transform: translate(10px, -10px) rotate(3deg); }
  }

  .page-container {
    position: relative;
    z-index: 1;
    padding: 40px 20px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .header-section {
    text-align: center;
    margin-bottom: 50px;
    animation: slideDown 0.6s ease-out;
  }

  @keyframes slideDown {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .page-title {
    font-size: 56px;
    font-weight: 900;
    background: linear-gradient(135deg, var(--deep-blue), var(--lavender), var(--coral));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 16px;
  }

  .page-subtitle {
    font-size: 20px;
    color: #333;
    max-width: 800px;
    margin: 0 auto;
    line-height: 1.6;
  }

  /* 3 categories on top, 2 on bottom */
  .categories-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  .categories-grid-bottom {
    display: grid;
    grid-template-columns: repeat(2, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
  }

  .category-card {
    background: var(--white);
    border-radius: 25px;
    padding: 30px;
    box-shadow: 0 8px 24px var(--shadow);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    animation: popUp 0.6s ease-out backwards;
    min-height: 550px;
    min-width: 220px;
    display: flex;
    flex-direction: column;
  }

  .category-card:nth-child(1) { animation-delay: 0.1s; }
  .category-card:nth-child(2) { animation-delay: 0.2s; }
  .category-card:nth-child(3) { animation-delay: 0.3s; }
  .category-card:nth-child(4) { animation-delay: 0.4s; }
  .category-card:nth-child(5) { animation-delay: 0.5s; }

  @keyframes popUp {
    from { transform: scale(0.9) translateY(30px); opacity: 0; }
    to { transform: scale(1) translateY(0); opacity: 1; }
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .card-title {
    font-size: 28px;
    font-weight: 900;
    margin: 0;
  }

  .card-badge {
    padding: 10px 22px;
    border-radius: 20px;
    font-size: 15px;
    font-weight: 700;
    white-space: nowrap;
  }

  .card-description {
    color: #666;
    font-size: 17px;
    margin-bottom: 20px;
    line-height: 1.6;
  }

  .items-grid {
    display: grid;
    gap: 14px;
    flex: 1;
  }

  .item-badge {
    padding: 16px 18px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 18px;
    text-align: center;
    transition: all 0.2s ease;
  }

  /* Color scheme for each category */
  .category-numbers .card-title { color: var(--deep-blue); }
  .category-numbers .card-badge { 
    background: linear-gradient(135deg, rgba(67, 97, 238, 0.2), rgba(76, 201, 240, 0.2));
    color: var(--deep-blue);
    border: 2px solid var(--deep-blue);
  }
  .category-numbers .items-grid { 
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(4, 1fr);
  }
  .category-numbers .item-badge {
    background: rgba(67, 97, 238, 0.1);
    color: var(--deep-blue);
    border: 2px solid rgba(67, 97, 238, 0.3);
  }

  .category-colors .card-title { color: var(--coral); }
  .category-colors .card-badge { 
    background: linear-gradient(135deg, rgba(255, 107, 157, 0.2), rgba(255, 140, 66, 0.2));
    color: var(--coral);
    border: 2px solid var(--coral);
  }
  .category-colors .items-grid { 
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(4, 1fr);
  }
  .category-colors .item-badge {
    background: rgba(255, 107, 157, 0.1);
    color: var(--coral);
    border: 2px solid rgba(255, 107, 157, 0.3);
  }

  .category-family .card-title { color: var(--lavender); }
  .category-family .card-badge { 
    background: linear-gradient(135deg, rgba(167, 139, 250, 0.2), rgba(67, 97, 238, 0.2));
    color: var(--lavender);
    border: 2px solid var(--lavender);
  }
  .category-family .items-grid { 
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(4, 1fr);
  }
  .category-family .item-badge {
    background: rgba(167, 139, 250, 0.1);
    color: var(--lavender);
    border: 2px solid rgba(167, 139, 250, 0.3);
  }

  .category-relationship .card-title { color: var(--grass-green); }
  .category-relationship .card-badge { 
    background: linear-gradient(135deg, rgba(6, 214, 160, 0.2), rgba(76, 201, 240, 0.2));
    color: var(--grass-green);
    border: 2px solid var(--grass-green);
  }
  .category-relationship .items-grid { 
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(4, 1fr);
  }
  .category-relationship .item-badge {
    background: rgba(6, 214, 160, 0.1);
    color: var(--grass-green);
    border: 2px solid rgba(6, 214, 160, 0.3);
  }

  .category-survival .card-title { color: var(--orange); }
  .category-survival .card-badge { 
    background: linear-gradient(135deg, rgba(255, 140, 66, 0.2), rgba(255, 211, 61, 0.2));
    color: var(--orange);
    border: 2px solid var(--orange);
  }
  .category-survival .items-grid { 
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(4, 1fr);
  }
  .category-survival .item-badge {
    background: rgba(255, 140, 66, 0.1);
    color: var(--orange);
    border: 2px solid rgba(255, 140, 66, 0.3);
  }

  /* Color badges special styling - REMOVED since colors now use standard item-badge */

  /* Video Detail View Styles */
  .detail-card {
    background: var(--white);
    border-radius: 25px;
    padding: 30px;
    box-shadow: 0 8px 24px var(--shadow);
    animation: fadeIn 0.6s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .detail-title {
    font-size: 32px;
    font-weight: 900;
    margin: 0;
  }

  .back-btn {
    padding: 12px 24px;
    background: linear-gradient(135deg, var(--orange), var(--sunshine));
    color: var(--white);
    border: none;
    border-radius: 15px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(255, 140, 66, 0.3);
  }

  .selection-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-bottom: 30px;
  }

  .select-btn {
    padding: 12px 20px;
    background: var(--white);
    color: #333;
    border: 2px solid var(--grass-green);
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    box-shadow: 0 2px 8px var(--shadow);
  }

  .select-btn.active {
    background: linear-gradient(135deg, var(--grass-green), var(--sky-blue));
    color: var(--white);
    border-color: var(--sky-blue);
  }

  .video-container {
    background: #000;
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 30px;
    box-shadow: 0 8px 24px var(--shadow);
  }

  .video-container video {
    /* Force hardware acceleration for smooth playback */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
  }

  .steps-section {
    background: var(--off-white);
    padding: 25px;
    border-radius: 20px;
    border: 3px dashed #DDD;
  }

  .steps-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--deep-blue);
    margin-bottom: 16px;
  }

  .steps-list {
    margin: 0;
    padding-left: 24px;
  }

  .steps-list li {
    font-size: 16px;
    color: #666;
    line-height: 1.8;
    margin-bottom: 12px;
  }

  @media (max-width: 1400px) {
    .categories-grid {
      grid-template-columns: repeat(3, minmax(220px, 1fr));
    }
    .categories-grid-bottom {
      grid-template-columns: repeat(2, minmax(220px, 1fr));
    }
  }

  @media (max-width: 1024px) {
    .categories-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    .categories-grid-bottom {
      grid-template-columns: 1fr;
      max-width: 600px;
    }
  }

  @media (max-width: 768px) {
    .page-title {
      font-size: 36px;
    }

    .categories-grid {
      grid-template-columns: 1fr;
    }

    .categories-grid-bottom {
      grid-template-columns: 1fr;
    }

    .category-numbers .items-grid,
    .category-colors .items-grid,
    .category-family .items-grid,
    .category-relationship .items-grid,
    .category-survival .items-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<div class="bg-shapes">
  <div class="shape"></div>
  <div class="shape"></div>
  <div class="shape"></div>
  <div class="shape"></div>
</div>

<div class="page-container">
  <!-- Header -->
  <div class="header-section">
    <h1 class="page-title">Learn Filipino Sign Language</h1>
    <p class="page-subtitle">
      Discover essential vocabulary through five core categories: Numbers, Colors, Family, Relationship, and Survival words.
    </p>
  </div>

  <!-- Top Row: 3 Categories -->
  <div class="categories-grid">
    <!-- Numbers -->
    <div class="category-card category-numbers" onclick="showCategory('numbers')">
      <div class="card-header">
        <h2 class="card-title">Numbers</h2>
        <span class="card-badge">5 Signs</span>
      </div>
      <p class="card-description">Learn numbers One to Five with step-by-step demos.</p>
      <div class="items-grid">
        <div class="item-badge">One</div>
        <div class="item-badge">Two</div>
        <div class="item-badge">Three</div>
        <div class="item-badge">Four</div>
        <div class="item-badge">Five</div>
        <div class="item-badge" style="visibility: hidden;"></div>
        <div class="item-badge" style="visibility: hidden;"></div>
        <div class="item-badge" style="visibility: hidden;"></div>
      </div>
    </div>

    <!-- Colors -->
    <div class="category-card category-colors" onclick="showCategory('colors')">
      <div class="card-header">
        <h2 class="card-title">Colors</h2>
        <span class="card-badge">8 Colors</span>
      </div>
      <p class="card-description">Master essential color signs with visual demonstrations.</p>
      <div class="items-grid">
        <div class="item-badge">Black</div>
        <div class="item-badge">Blue</div>
        <div class="item-badge">Green</div>
        <div class="item-badge">Orange</div>
        <div class="item-badge">Pink</div>
        <div class="item-badge">Red</div>
        <div class="item-badge">White</div>
        <div class="item-badge">Yellow</div>
      </div>
    </div>

    <!-- Family -->
    <div class="category-card category-family" onclick="showCategory('family')">
      <div class="card-header">
        <h2 class="card-title">Family</h2>
        <span class="card-badge">6 Terms</span>
      </div>
      <p class="card-description">Learn common family terms used in daily life.</p>
      <div class="items-grid">
        <div class="item-badge">Daughter</div>
        <div class="item-badge">Father</div>
        <div class="item-badge">Grandfather</div>
        <div class="item-badge">Grandmother</div>
        <div class="item-badge">Mother</div>
        <div class="item-badge">Son</div>
        <div class="item-badge" style="visibility: hidden;"></div>
        <div class="item-badge" style="visibility: hidden;"></div>
      </div>
    </div>
  </div>

  <!-- Bottom Row: 2 Categories (Centered) -->
  <div class="categories-grid-bottom">
    <!-- Relationship -->
    <div class="category-card category-relationship" onclick="showCategory('relationship')">
      <div class="card-header">
        <h2 class="card-title">Relationship</h2>
        <span class="card-badge">4 Signs</span>
      </div>
      <p class="card-description">Essential relationship terms for social interactions.</p>
      <div class="items-grid">
        <div class="item-badge">Boy</div>
        <div class="item-badge">Girl</div>
        <div class="item-badge">Man</div>
        <div class="item-badge">Woman</div>
        <div class="item-badge" style="visibility: hidden;"></div>
        <div class="item-badge" style="visibility: hidden;"></div>
        <div class="item-badge" style="visibility: hidden;"></div>
        <div class="item-badge" style="visibility: hidden;"></div>
      </div>
    </div>

    <!-- Survival -->
    <div class="category-card category-survival" onclick="showCategory('survival')">
      <div class="card-header">
        <h2 class="card-title">Survival</h2>
        <span class="card-badge">6 Words</span>
      </div>
      <p class="card-description">Critical communication words for everyday situations.</p>
      <div class="items-grid">
        <div class="item-badge">Correct</div>
        <div class="item-badge">Don't Understand</div>
        <div class="item-badge">No</div>
        <div class="item-badge">Understand</div>
        <div class="item-badge">Wrong</div>
        <div class="item-badge">Yes</div>
        <div class="item-badge" style="visibility: hidden;"></div>
        <div class="item-badge" style="visibility: hidden;"></div>
      </div>
    </div>
  </div>

  <!-- Video Selection View (Hidden by default) -->
  <div id="videoView" style="display:none;">
    <div class="detail-card">
      <div class="detail-header">
        <h2 id="videoTitle" class="detail-title">Category Videos</h2>
        <button class="back-btn" onclick="hideVideoView()">‚Üê Back to Categories</button>
      </div>

      <p id="videoDescription" style="color:#666;margin-bottom:24px;"></p>

      <div id="videoButtons" class="selection-buttons"></div>

      <div class="video-container">
        <video id="mainVideo" controls playsinline preload="auto" muted onloadedmetadata="this.muted = true;" style="width:100%;max-height:800px;border-radius:20px;">
          Your browser does not support the video tag.
        </video>
      </div>

      <div class="steps-section">
        <h4 class="steps-title">Learning Steps</h4>
        <ol id="videoSteps" class="steps-list"></ol>
      </div>
    </div>
  </div>

</div>

<script>
  const CATEGORIES = {
    numbers: {
      title: "Numbers Learning Module",
      description: "Master numbers One to Five with short demos.",
      items: ["one","two","three","four","five"],
      color: "var(--deep-blue)"
    },
    colors: {
      title: "Colors Learning Module",
      description: "Learn color signs with visual demonstrations.",
      items: ["black","blue","green","orange","pink","red","white","yellow"],
      color: "var(--coral)"
    },
    family: {
      title: "Family Learning Module",
      description: "Learn essential family relationships and terms.",
      items: ["daughter","father","grandfather","grandmother","mother","son"],
      color: "var(--lavender)"
    },
    relationship: {
      title: "Relationship Learning Module",
      description: "Learn essential relationship terms for social interactions.",
      items: ["boy","girl","man","woman"],
      color: "var(--grass-green)"
    },
    survival: {
      title: "Survival Learning Module",
      description: "Learn critical communication words for everyday situations.",
      items: ["correct","dontunderstand","no","understand","wrong","yes"],
      color: "var(--orange)"
    }
  };

  const titleCase = s => s.charAt(0).toUpperCase() + s.slice(1);
  const formatLabel = s => s.replace(/dontunderstand/i, "Don't Understand");

  let VIDEO = null;
  async function loadManifest(){
    if (VIDEO) return VIDEO;
    try{
      const res = await fetch("/static/manifest.json?v=1");
      VIDEO = await res.json();
    }catch(e){
      console.warn("Manifest not found, using fallback paths.", e);
      VIDEO = {};
    }
    return VIDEO;
  }

  function pickRandom(arr){ 
    return (arr && arr.length) ? arr[Math.floor(Math.random()*arr.length)] : null; 
  }

  function posterFromSrc(src){
    return src.replace('/static/video/', '/static/posters/').replace(/\.mp4$/i, '.jpg');
  }

  function showCategory(categoryKey) {
    const cat = CATEGORIES[categoryKey];
    if (!cat) return;

    document.querySelector('.categories-grid').style.display = 'none';
    document.querySelector('.categories-grid-bottom').style.display = 'none';
    document.getElementById('videoView').style.display = 'block';

    document.getElementById('videoTitle').textContent = cat.title;
    document.getElementById('videoTitle').style.background = `linear-gradient(135deg, ${cat.color}, var(--lavender))`;
    document.getElementById('videoTitle').style.webkitBackgroundClip = 'text';
    document.getElementById('videoTitle').style.backgroundClip = 'text';
    document.getElementById('videoTitle').style.webkitTextFillColor = 'transparent';
    document.getElementById('videoDescription').textContent = cat.description;

    const buttonsContainer = document.getElementById('videoButtons');
    buttonsContainer.innerHTML = '';

    cat.items.forEach((item, index) => {
      const btn = document.createElement('button');
      btn.className = 'select-btn';
      btn.textContent = formatLabel(titleCase(item));
      btn.onclick = () => loadVideo(categoryKey, item, btn);
      buttonsContainer.appendChild(btn);
    });

    loadVideo(categoryKey, cat.items[0], buttonsContainer.children[0]);
  }

  async function loadVideo(category, item, btnElement) {
    await loadManifest();

    document.querySelectorAll('#videoButtons .select-btn').forEach(b => {
      b.classList.remove('active');
    });
    if(btnElement) btnElement.classList.add('active');

    const video = document.getElementById('mainVideo');
    const steps = document.getElementById('videoSteps');

    // Pause current video before switching
    video.pause();
    
    const list = VIDEO?.[category]?.[item];
    let src = pickRandom(list);

    // Fallback: try item_01.mp4 ... item_10.mp4, then item.mp4
    if (!src) {
      const base = `/static/video/${category}/${item}`;
      const candidates = [];
      for (let i = 1; i <= 10; i++) {
        candidates.push(`${base}_${String(i).padStart(2, "0")}.mp4`);
      }
      candidates.push(`${base}.mp4`);

      // pick the first one that exists
      for (const u of candidates) {
        try {
          const r = await fetch(u, { method: "HEAD", cache: "no-store" });
          if (r.ok) { src = u; break; }
        } catch (_) {}
      }
    }

    if (!src) {
      console.warn("No video found for", category, item);
      src = `/static/video/${category}/${item}.mp4`; // last resort
    }

    const poster = posterFromSrc(src);

    // Set video properties for smooth playback
    video.playbackRate = 1.0;
    video.defaultPlaybackRate = 1.0;
    
    video.src = src;
    video.poster = poster;
    
    // Load and prepare video
    video.load();
    
    // Wait for video to be ready
    video.addEventListener('loadedmetadata', function onLoaded() {
      video.removeEventListener('loadedmetadata', onLoaded);
      // Ensure playback rate is set correctly after loading
      video.playbackRate = 1.0;
    });

    const SAMPLE = [
      'Face the camera with clear hands.',
      'Form the correct handshape/motion.',
      'Hold the final pose briefly, then relax.',
    ];
    steps.innerHTML = '';
    SAMPLE.forEach(s => {
      const li = document.createElement('li');
      li.textContent = s;
      steps.appendChild(li);
    });
  }

  function hideVideoView() {
    document.querySelector('.categories-grid').style.display = 'grid';
    document.querySelector('.categories-grid-bottom').style.display = 'grid';
    document.getElementById('videoView').style.display = 'none';
    document.getElementById('mainVideo').pause();
  }
</script>

{% endblock %}